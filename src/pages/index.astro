---
export const prerender = false;

import type { ResumeConfig, SiteConfig } from '../types/resume';
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import Experience from '../components/Experience.astro';
import Projects from '../components/Projects.astro';
import Skills from '../components/Skills.astro';
import Education from '../components/Education.astro';
import { fetchMeta, fetchPublishedResume } from '../lib/api';
import { normalizeResume } from '../lib/normalizeResume';

const baseUrl = import.meta.env.BASE_URL;

const fallbackSite: SiteConfig = {
  title: 'Resume',
  description: 'Resume not published yet.',
  theme: 'auto',
  language: 'en'
};

let resume: ResumeConfig | null = null;
let site: SiteConfig = fallbackSite;
let errorMessage: string | null = null;
let meta = {
  appVersion: '',
  opsVersion: ''
};

try {
  const data = await fetchPublishedResume();
  if (data) {
    resume = normalizeResume(data.resume, baseUrl);
    site = resume.site;
  }
} catch (error) {
  errorMessage = error instanceof Error ? error.message : 'Unable to load resume.';
}

const metaPayload = await fetchMeta();
if (metaPayload) {
  meta = metaPayload;
}

const profileName = resume?.profile?.name?.trim() || '';
const siteTitle = site.title?.trim() || '';
const autoTitle = profileName ? `${profileName}的简历` : siteTitle || fallbackSite.title;
const pageTitle = siteTitle && !siteTitle.includes('个人主页') ? siteTitle : autoTitle;
---

<Layout
  title={pageTitle}
  description={site.description}
  keywords={site.keywords}
  language={site.language}
  meta={meta}
>
  {errorMessage && (
    <section class="py-16">
      <div class="section-container">
        <div class="card text-center">
          <h1 class="text-2xl font-bold mb-2">简历暂不可用</h1>
          <p style="color: var(--color-text-secondary);">{errorMessage}</p>
        </div>
      </div>
    </section>
  )}

  {!errorMessage && !resume && (
    <section class="py-16">
      <div class="section-container">
        <div class="card text-center">
          <h1 class="text-2xl font-bold mb-2">简历尚未发布</h1>
          <p style="color: var(--color-text-secondary);">
            请在后台发布最新草稿。
          </p>
        </div>
      </div>
    </section>
  )}

  {resume && (
    <>
      <Hero profile={resume.profile} />
      <Experience experience={resume.experience} />
      <Projects projects={resume.projects} />
      <Skills skills={resume.skills} />
      {resume.education && <Education education={resume.education} />}
    </>
  )}
</Layout>
