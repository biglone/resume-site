---
import { parse } from 'yaml';
import { readFileSync } from 'fs';
import { join } from 'path';
import type { ResumeConfig } from '../types/resume';

import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import Experience from '../components/Experience.astro';
import Projects from '../components/Projects.astro';
import Skills from '../components/Skills.astro';

// Read and parse resume configuration
const configPath = join(process.cwd(), 'src/config/resume.yaml');
const configFile = readFileSync(configPath, 'utf-8');
const config = parse(configFile) as ResumeConfig;

// Helper to prefix paths with BASE_URL
const baseUrl = import.meta.env.BASE_URL;
const prefixPath = (path: string) => {
  if (!path || path.startsWith('http://') || path.startsWith('https://')) {
    return path;
  }
  return path.startsWith('/') ? `${baseUrl}${path.slice(1)}` : `${baseUrl}${path}`;
};

// Transform image paths to include base URL
const profile = {
  ...config.profile,
  avatar: prefixPath(config.profile.avatar),
};

const experience = config.experience.map(exp => ({
  ...exp,
  logo: exp.logo ? prefixPath(exp.logo) : undefined,
}));

const projects = config.projects.map(proj => ({
  ...proj,
  images: proj.images?.map(img => ({
    ...img,
    src: prefixPath(img.src),
  })),
}));

const { skills, site } = config;
---

<Layout
  title={site.title}
  description={site.description}
  keywords={site.keywords}
  language={site.language}
>
  <Hero profile={profile} />
  <Experience experience={experience} />
  <Projects projects={projects} />
  <Skills skills={skills} />
</Layout>
