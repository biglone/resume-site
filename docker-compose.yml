services:
  api:
    image: ghcr.io/biglone/resume-site-api:latest
    build:
      context: ./server
    ports:
      - "127.0.0.1:${API_PORT:-4000}:4000"
    env_file:
      - ./server/.env
    environment:
      DATA_DIR: /app/data
      SEED_RESUME_PATH: /app/seed/resume.yaml
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:4321,http://localhost:5173,http://127.0.0.1:4321,http://127.0.0.1:5173}
    volumes:
      - ./server/data:/app/data
      - ./src/config/resume.yaml:/app/seed/resume.yaml:ro
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  web:
    image: ghcr.io/biglone/resume-site-web:latest
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ASTRO_SITE: ${ASTRO_SITE:-http://localhost:4321}
        ASTRO_BASE: ${ASTRO_BASE:-/}
    ports:
      - "${WEB_PORT:-4321}:4321"
    environment:
      API_BASE_URL: ${API_BASE_URL:-http://api:4000}
      HOST: 0.0.0.0
      PORT: 4321
      ASTRO_BASE: ${ASTRO_BASE:-/}
      ASTRO_SITE: ${ASTRO_SITE:-http://localhost:4321}
      ADMIN_URL: ${ADMIN_URL:-http://localhost:5173}
    depends_on:
      - api
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  admin:
    image: ghcr.io/biglone/resume-site-admin:latest
    build:
      context: ./admin
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:4000}
        VITE_PUBLIC_SITE_URL: ${VITE_PUBLIC_SITE_URL:-http://localhost:4321}
    ports:
      - "${ADMIN_PORT:-5173}:80"
    depends_on:
      - api
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    image: containrrr/watchtower:1.7.1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --label-enable --cleanup --interval 300
    environment:
      WATCHTOWER_LABEL_ENABLE: "true"
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_POLL_INTERVAL: "300"
      DOCKER_API_VERSION: "1.53"
    restart: unless-stopped
